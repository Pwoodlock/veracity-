# frozen_string_literal: true

class VulnerabilityAlertsController < ApplicationController
  before_action :authenticate_user!
  before_action :set_vulnerability_alert, only: [:show, :edit, :update, :destroy, :acknowledge, :resolve, :ignore]

  def index
    @vulnerability_alerts = VulnerabilityAlert.includes(:server, :cve_watchlist)
                                               .order(created_at: :desc)

    # Filter by status
    if params[:status].present?
      @vulnerability_alerts = @vulnerability_alerts.where(status: params[:status])
    else
      # Default to active alerts
      @vulnerability_alerts = @vulnerability_alerts.active
    end

    # Filter by severity
    if params[:severity].present?
      @vulnerability_alerts = @vulnerability_alerts.where(severity: params[:severity].upcase)
    end

    # Filter by server
    if params[:server_id].present?
      @vulnerability_alerts = @vulnerability_alerts.where(server_id: params[:server_id])
    end

    # Filter by exploited status
    if params[:exploited] == 'true'
      @vulnerability_alerts = @vulnerability_alerts.where(is_exploited: true)
    end

    # Pagination using Pagy
    @pagy, @vulnerability_alerts = pagy(@vulnerability_alerts, items: 50)

    # Statistics
    @stats = {
      total: VulnerabilityAlert.count,
      active: VulnerabilityAlert.active.count,
      critical: VulnerabilityAlert.active.critical.count,
      high: VulnerabilityAlert.active.where(severity: 'HIGH').count,
      exploited: VulnerabilityAlert.active.where(is_exploited: true).count,
      acknowledged: VulnerabilityAlert.where(status: 'acknowledged').count,
      patched: VulnerabilityAlert.where(status: 'patched').count
    }
  end

  def show
    # Additional details loaded via set_vulnerability_alert
  end

  def edit
    # Allow editing notes and resolution details
  end

  def update
    if @vulnerability_alert.update(vulnerability_alert_params)
      flash[:notice] = 'Vulnerability alert updated successfully'
      redirect_to vulnerability_alert_path(@vulnerability_alert)
    else
      flash.now[:error] = 'Failed to update alert'
      render :edit
    end
  end

  def destroy
    @vulnerability_alert.destroy
    flash[:notice] = 'Vulnerability alert deleted successfully'
    redirect_to vulnerability_alerts_path
  end

  def acknowledge
    @vulnerability_alert.update!(
      status: 'acknowledged',
      acknowledged_at: Time.current,
      acknowledged_by: current_user.email,
      acknowledged_by_user_id: current_user.id
    )

    respond_to do |format|
      format.html do
        flash[:notice] = 'Alert acknowledged'
        redirect_back(fallback_location: vulnerability_alerts_path)
      end
      format.json { render json: { success: true, message: 'Alert acknowledged' } }
    end
  end

  def resolve
    @vulnerability_alert.update!(
      status: 'patched',
      resolved_at: Time.current,
      resolved_by: current_user.email,
      resolved_by_user_id: current_user.id,
      resolution_notes: params[:resolution_notes]
    )

    respond_to do |format|
      format.html do
        flash[:notice] = 'Alert marked as patched'
        redirect_back(fallback_location: vulnerability_alerts_path)
      end
      format.json { render json: { success: true, message: 'Alert marked as patched' } }
    end
  end

  def ignore
    @vulnerability_alert.update!(
      status: 'ignored',
      resolved_at: Time.current,
      resolved_by: current_user.email,
      resolved_by_user_id: current_user.id
    )

    respond_to do |format|
      format.html do
        flash[:notice] = 'Alert ignored'
        redirect_back(fallback_location: vulnerability_alerts_path)
      end
      format.json { render json: { success: true, message: 'Alert ignored' } }
    end
  end

  def bulk_acknowledge
    ids = params[:alert_ids] || []
    VulnerabilityAlert.where(id: ids).update_all(
      status: 'acknowledged',
      acknowledged_at: Time.current,
      acknowledged_by: current_user.email,
      acknowledged_by_user_id: current_user.id
    )

    respond_to do |format|
      format.html do
        flash[:notice] = "#{ids.size} alerts acknowledged"
        redirect_back(fallback_location: vulnerability_alerts_path)
      end
      format.json { render json: { success: true, message: "#{ids.size} alerts acknowledged" } }
    end
  end

  def bulk_resolve
    ids = params[:alert_ids] || []
    VulnerabilityAlert.where(id: ids).update_all(
      status: 'patched',
      resolved_at: Time.current,
      resolved_by: current_user.email,
      resolved_by_user_id: current_user.id
    )

    respond_to do |format|
      format.html do
        flash[:notice] = "#{ids.size} alerts marked as patched"
        redirect_back(fallback_location: vulnerability_alerts_path)
      end
      format.json { render json: { success: true, message: "#{ids.size} alerts marked as patched" } }
    end
  end

  def bulk_ignore
    ids = params[:alert_ids] || []
    VulnerabilityAlert.where(id: ids).update_all(
      status: 'ignored',
      resolved_at: Time.current,
      resolved_by: current_user.email,
      resolved_by_user_id: current_user.id
    )

    respond_to do |format|
      format.html do
        flash[:notice] = "#{ids.size} alerts ignored"
        redirect_back(fallback_location: vulnerability_alerts_path)
      end
      format.json { render json: { success: true, message: "#{ids.size} alerts ignored" } }
    end
  end

  private

  def set_vulnerability_alert
    @vulnerability_alert = VulnerabilityAlert.find(params[:id])
  end

  def vulnerability_alert_params
    params.require(:vulnerability_alert).permit(
      :resolution_notes
    )
  end
end
