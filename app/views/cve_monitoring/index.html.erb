<% content_for :head do %>
  <title>CVE Monitoring - Server Manager</title>
<% end %>

<%= render layout: 'shared/sidebar' do %>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-base-content">CVE Vulnerability Monitoring</h1>
      <p class="text-base-content/80 mt-1">Monitor and track Common Vulnerabilities and Exposures affecting your infrastructure</p>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Total Alerts Card -->
      <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-base-content/80 uppercase tracking-wide">Total Alerts</p>
            <p class="mt-2 text-3xl font-bold text-base-content"><%= @stats[:total_alerts] || 0 %></p>
          </div>
        </div>
      </div>

      <!-- Critical Alerts Card -->
      <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-error uppercase tracking-wide">Critical</p>
            <p class="mt-2 text-3xl font-bold text-error"><%= @stats[:critical_alerts] || 0 %></p>
          </div>
        </div>
      </div>

      <!-- Active Watchlists Card -->
      <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-primary/80 uppercase tracking-wide">Watchlists</p>
            <p class="mt-2 text-3xl font-bold text-primary/80"><%= @stats[:watchlists] || 0 %></p>
          </div>
        </div>
      </div>

      <!-- Monitored Servers Card -->
      <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-success uppercase tracking-wide">Monitored</p>
            <p class="mt-2 text-3xl font-bold text-success"><%= @stats[:servers_monitored] || 0 %></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions Bar -->
    <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg p-6 mb-8">
      <h2 class="text-lg font-semibold text-base-content mb-4">Quick Actions</h2>
      <div class="flex flex-wrap gap-3">
        <%= link_to cve_monitoring_alerts_path, class: "btn btn-primary" do %>
          <span>View All Alerts</span>
        <% end %>
        <%= link_to cve_monitoring_watchlists_path, class: "btn btn-ghost" do %>
          <span>Manage Watchlists</span>
        <% end %>
        <%= link_to new_cve_watchlist_path, class: "btn btn-success" do %>
          <span>Add Watchlist</span>
        <% end %>
        <% if current_user&.admin? %>
          <%= button_to setup_cve_monitoring_path, method: :post,
              data: { turbo_confirm: "This will create default watchlists for common software. Continue?" },
              class: "btn btn-secondary" do %>
            <span>Setup Defaults</span>
          <% end %>
        <% end %>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Recent Alerts Section -->
      <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg">
        <div class="p-6 border-b border-base-content/10">
          <h2 class="text-lg font-semibold text-base-content">Recent Vulnerability Alerts</h2>
        </div>
        <div class="p-6">
          <% if @recent_alerts && @recent_alerts.any? %>
            <div class="space-y-4">
              <% @recent_alerts.each do |alert| %>
                <div class="border-l-4 <%= alert.critical? ? 'border-error' : alert.severity == 'HIGH' ? 'border-warning' : 'border-warning' %> pl-4">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <div class="flex items-center gap-2">
                        <%= link_to alert.cve_id, cve_monitoring_alert_path(alert),
                            class: "font-medium text-primary hover:text-primary-focus" %>
                        <span class="px-2 py-1 text-xs rounded-full <%= alert.severity_badge_class %>">
                          <%= alert.severity %>
                        </span>
                        <% if alert.is_exploited %>
                          <span class="badge badge-error badge-xs">EXPLOITED</span>
                        <% end %>
                      </div>
                      <p class="text-sm text-base-content/80 mt-1">
                        <span class="font-medium"><%= alert.server&.hostname || 'Global' %></span> •
                        <%= time_ago_in_words(alert.created_at) %> ago
                      </p>
                      <% if alert.description.present? %>
                        <p class="text-sm text-base-content/60 mt-2"><%= truncate(alert.description, length: 150) %></p>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-base-content/60 text-center py-8">No vulnerability alerts yet</p>
          <% end %>
        </div>
      </div>

      <!-- Active Watchlists Section -->
      <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg">
        <div class="p-6 border-b border-base-content/10">
          <h2 class="text-lg font-semibold text-base-content">Active Watchlists</h2>
        </div>
        <div class="p-6">
          <% if @watchlists && @watchlists.any? %>
            <div class="space-y-3">
              <% @watchlists.each do |watchlist| %>
                <div class="flex items-center justify-between p-4 bg-base-200 rounded-lg hover:bg-base-300 transition-colors">
                  <div class="flex-1">
                    <%= link_to watchlist.display_name, cve_watchlist_path(watchlist),
                        class: "font-medium text-base-content hover:text-primary" %>
                    <p class="text-sm text-base-content/80 mt-1">
                      <%= watchlist.description || "#{watchlist.vendor}/#{watchlist.product}" %>
                    </p>
                    <p class="text-xs text-base-content/60 mt-1">
                      Last checked: <%= watchlist.last_checked_at&.strftime('%b %d %H:%M') || 'Never' %> •
                      Hits: <%= watchlist.hits_count %>
                    </p>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="badge <%= watchlist.active? ? 'badge-success' : 'badge-ghost' %> badge-sm">
                      <%= watchlist.active? ? 'Active' : 'Inactive' %>
                    </span>
                    <%= button_to "Scan", scan_cve_watchlist_path(watchlist), method: :post,
                        class: "btn btn-primary btn-xs" %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center py-8">
              <p class="text-base-content/60 mb-4">No watchlists configured yet</p>
              <div class="flex justify-center gap-3">
                <%= link_to "Create watchlist", new_cve_watchlist_path,
                    class: "text-primary hover:text-primary-focus" %>
                <span class="text-base-content/60">or</span>
                <%= button_to "Setup defaults", setup_cve_monitoring_path, method: :post,
                    class: "text-primary hover:text-primary-focus" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Vulnerable Servers Table -->
    <% if @vulnerable_servers && @vulnerable_servers.any? %>
      <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg mb-8">
        <div class="p-6 border-b border-base-content/10">
          <h2 class="text-lg font-semibold text-base-content">Most Vulnerable Servers</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-base-content/10">
            <thead class="bg-base-100">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">Server</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">OS</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">Vulnerabilities</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-base-200 divide-y divide-base-content/10">
              <% @vulnerable_servers.each do |server| %>
                <tr class="hover:bg-base-200">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <%= link_to server.hostname, server_path(server),
                        class: "text-primary hover:text-primary-focus" %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
                    <%= server.os_name %> <%= server.os_version %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="badge badge-error badge-sm">
                      <%= server.vuln_count %> alerts
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <%= button_to "Scan", scan_server_cve_path(server), method: :post,
                        class: "text-primary hover:text-primary-focus" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  </div>
<% end %>
