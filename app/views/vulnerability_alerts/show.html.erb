<% content_for :head do %>
  <title><%= @vulnerability_alert.cve_id %> - <%= SystemSetting.company_name %></title>
<% end %>

<%= render 'shared/navigation' %>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header -->
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-base-content"><%= @vulnerability_alert.cve_id %></h1>
        <p class="mt-2 text-sm text-base-content/60">Vulnerability Alert Details</p>
      </div>
      <%= link_to vulnerability_alerts_path, class: "btn btn-ghost" do %>
        <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        Back to Alerts
      <% end %>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Main Content -->
      <div class="lg:col-span-2 space-y-6">

        <!-- Alert Summary -->
        <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-base-content">Alert Summary</h2>
            <div class="flex items-center space-x-2">
              <% case @vulnerability_alert.severity %>
              <% when 'CRITICAL' %>
                <span class="badge badge-error">CRITICAL</span>
              <% when 'HIGH' %>
                <span class="badge badge-warning">HIGH</span>
              <% when 'MEDIUM' %>
                <span class="badge badge-warning badge-outline">MEDIUM</span>
              <% when 'LOW' %>
                <span class="badge badge-primary">LOW</span>
              <% else %>
                <span class="badge badge-ghost">INFO</span>
              <% end %>

              <% if @vulnerability_alert.is_exploited %>
                <span class="badge badge-secondary">CISA KEV</span>
              <% end %>
            </div>
          </div>

          <div class="prose prose-invert max-w-none">
            <p class="text-base-content/80"><%= @vulnerability_alert.description || 'No description available' %></p>
          </div>
        </div>

        <!-- Scoring -->
        <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-semibold text-base-content mb-4">Vulnerability Scoring</h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <% if @vulnerability_alert.cvss_score %>
              <div>
                <div class="text-sm text-base-content/60 mb-2">CVSS Score</div>
                <div class="text-3xl font-bold text-base-content"><%= number_with_precision(@vulnerability_alert.cvss_score, precision: 1) %></div>
                <div class="mt-2">
                  <div class="w-full bg-base-200 rounded-full h-2">
                    <div class="bg-<%= @vulnerability_alert.cvss_score >= 9 ? 'error' : @vulnerability_alert.cvss_score >= 7 ? 'warning' : @vulnerability_alert.cvss_score >= 4 ? 'warning' : 'primary' %> h-2 rounded-full"
                         style="width: <%= (@vulnerability_alert.cvss_score / 10.0 * 100).round %>%"></div>
                  </div>
                </div>
                <% if @vulnerability_alert.cvss_vector %>
                  <div class="mt-2 text-xs font-mono text-base-content/60"><%= @vulnerability_alert.cvss_vector %></div>
                <% end %>
              </div>
            <% end %>

            <% if @vulnerability_alert.epss_score %>
              <div>
                <div class="text-sm text-base-content/60 mb-2">EPSS Score (Exploit Probability)</div>
                <div class="text-3xl font-bold text-base-content"><%= ((@vulnerability_alert.epss_score * 100).round(2)) %>%</div>
                <div class="mt-2">
                  <div class="w-full bg-base-200 rounded-full h-2">
                    <div class="bg-secondary h-2 rounded-full"
                         style="width: <%= (@vulnerability_alert.epss_score * 100).round %>%"></div>
                  </div>
                </div>
                <div class="mt-2 text-xs text-base-content/60">Likelihood of exploitation in the wild</div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Solution/Mitigation -->
        <% if @vulnerability_alert.solution.present? %>
          <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-base-content mb-4">Solution / Mitigation</h2>
            <div class="prose prose-invert max-w-none text-base-content/80">
              <%= simple_format(@vulnerability_alert.solution) %>
            </div>
          </div>
        <% end %>

        <!-- Resolution Notes -->
        <% if @vulnerability_alert.resolution_notes.present? %>
          <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-base-content mb-4">Resolution Notes</h2>
            <div class="prose prose-invert max-w-none text-base-content/80">
              <%= simple_format(@vulnerability_alert.resolution_notes) %>
            </div>
            <% if @vulnerability_alert.resolved_by %>
              <div class="mt-4 text-sm text-base-content/60">
                Resolved by <%= @vulnerability_alert.resolved_by %> <%= time_ago_in_words(@vulnerability_alert.resolved_at) %> ago
              </div>
            <% end %>
          </div>
        <% end %>

      </div>

      <!-- Sidebar -->
      <div class="space-y-6">

        <!-- Quick Info -->
        <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-base-content mb-4">Quick Info</h3>

          <dl class="space-y-3">
            <div>
              <dt class="text-xs text-base-content/60">Server</dt>
              <dd class="text-sm text-base-content">
                <% if @vulnerability_alert.server %>
                  <%= link_to @vulnerability_alert.server.hostname, server_path(@vulnerability_alert.server), class: "text-primary hover:text-primary-focus" %>
                <% else %>
                  <span class="text-base-content/60">Global Alert</span>
                <% end %>
              </dd>
            </div>

            <div>
              <dt class="text-xs text-base-content/60">Watchlist</dt>
              <dd class="text-sm text-base-content">
                <% if @vulnerability_alert.cve_watchlist %>
                  <%= link_to @vulnerability_alert.cve_watchlist.display_name, cve_watchlist_path(@vulnerability_alert.cve_watchlist), class: "text-primary hover:text-primary-focus" %>
                <% else %>
                  <span class="text-base-content/60">None</span>
                <% end %>
              </dd>
            </div>

            <div>
              <dt class="text-xs text-base-content/60">Published</dt>
              <dd class="text-sm text-base-content">
                <%= @vulnerability_alert.published_at ? @vulnerability_alert.published_at.strftime('%Y-%m-%d') : 'Unknown' %>
              </dd>
            </div>

            <% if @vulnerability_alert.modified_at %>
              <div>
                <dt class="text-xs text-base-content/60">Last Modified</dt>
                <dd class="text-sm text-base-content">
                  <%= @vulnerability_alert.modified_at.strftime('%Y-%m-%d') %>
                </dd>
              </div>
            <% end %>

            <div>
              <dt class="text-xs text-base-content/60">Status</dt>
              <dd class="text-sm">
                <% case @vulnerability_alert.status %>
                <% when 'new' %>
                  <span class="badge badge-error badge-sm">New</span>
                <% when 'acknowledged' %>
                  <span class="badge badge-warning badge-sm">Acknowledged</span>
                <% when 'investigating' %>
                  <span class="badge badge-primary badge-sm">Investigating</span>
                <% when 'patched' %>
                  <span class="badge badge-success badge-sm">Patched</span>
                <% when 'ignored' %>
                  <span class="badge badge-ghost badge-sm">Ignored</span>
                <% end %>
              </dd>
            </div>
          </dl>
        </div>

        <!-- Actions -->
        <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-base-content mb-4">Actions</h3>

          <div class="space-y-2">
            <% if @vulnerability_alert.status == 'new' %>
              <%= button_to 'Acknowledge', acknowledge_vulnerability_alert_path(@vulnerability_alert), method: :post,
                  class: "btn btn-warning w-full" %>
            <% end %>

            <% if @vulnerability_alert.active? %>
              <%= button_to 'Mark as Patched', resolve_vulnerability_alert_path(@vulnerability_alert), method: :post,
                  data: { confirm: 'Have you verified this vulnerability has been patched?' },
                  class: "btn btn-success w-full" %>

              <%= button_to 'Ignore', ignore_vulnerability_alert_path(@vulnerability_alert), method: :post,
                  data: { confirm: 'Are you sure you want to ignore this alert?' },
                  class: "btn btn-ghost w-full" %>
            <% end %>

            <%= button_to 'Delete', vulnerability_alert_path(@vulnerability_alert), method: :delete,
                data: { confirm: 'Are you sure?' },
                class: "btn btn-error w-full" %>
          </div>
        </div>

        <!-- External Links -->
        <div class="bg-base-200 border border-primary rounded-lg p-4">
          <h3 class="text-sm font-semibold text-primary/80 mb-3">External References</h3>
          <div class="space-y-2">
            <%= link_to "https://nvd.nist.gov/vuln/detail/#{@vulnerability_alert.cve_id}", target: "_blank", rel: "noopener",
                class: "block text-sm text-primary hover:text-primary-focus" do %>
              NVD Database →
            <% end %>
            <%= link_to "https://cve.mitre.org/cgi-bin/cvename.cgi?name=#{@vulnerability_alert.cve_id}", target: "_blank", rel: "noopener",
                class: "block text-sm text-primary hover:text-primary-focus" do %>
              MITRE CVE →
            <% end %>
            <% if @vulnerability_alert.is_exploited %>
              <%= link_to "https://www.cisa.gov/known-exploited-vulnerabilities", target: "_blank", rel: "noopener",
                  class: "block text-sm text-secondary hover:text-secondary-focus" do %>
                CISA KEV Catalog →
              <% end %>
            <% end %>
          </div>
        </div>

      </div>

    </div>

  </div>
