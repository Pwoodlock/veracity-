<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug: <%= @cve_watchlist.display_name %> - <%= SystemSetting.company_name %></title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-base-300">

<%= render 'shared/navigation' %>

  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header -->
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-base-content">API Debug</h1>
        <p class="mt-2 text-sm text-base-content/60"><%= @cve_watchlist.display_name %></p>
      </div>
      <%= link_to cve_watchlist_path(@cve_watchlist), class: "px-4 py-2 bg-base-200 text-white rounded-lg hover:bg-base-200" do %>
        <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        Back to Watchlist
      <% end %>
    </div>

    <% if @debug_info[:error] %>
      <!-- Error Display -->
      <div class="alert alert-error mb-6">
        <h2 class="text-xl font-semibold mb-4">Error</h2>
        <p class="mb-4"><%= @debug_info[:error] %></p>
        <% if @debug_info[:backtrace] %>
          <details class="mt-4">
            <summary class="cursor-pointer hover:underline">Show Backtrace</summary>
            <pre class="mt-2 text-xs bg-error/10 p-3 rounded overflow-x-auto"><%= @debug_info[:backtrace].join("\n") %></pre>
          </details>
        <% end %>
      </div>
    <% else %>
      <!-- Request Information -->
      <div class="bg-base-200 border border-base-content/10 rounded-lg p-6 mb-6">
        <h2 class="text-xl font-semibold text-base-content mb-4">API Request</h2>
        <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <dt class="text-sm text-base-content/60">API URL</dt>
            <dd class="text-sm text-base-content font-mono bg-base-200 px-2 py-1 rounded mt-1"><%= @debug_info[:request][:api_url] %></dd>
          </div>
          <div>
            <dt class="text-sm text-base-content/60">Vendor</dt>
            <dd class="text-sm text-base-content font-mono bg-base-200 px-2 py-1 rounded mt-1"><%= @debug_info[:request][:vendor] %></dd>
          </div>
          <div>
            <dt class="text-sm text-base-content/60">Product</dt>
            <dd class="text-sm text-base-content font-mono bg-base-200 px-2 py-1 rounded mt-1"><%= @debug_info[:request][:product] %></dd>
          </div>
          <div>
            <dt class="text-sm text-base-content/60">Version</dt>
            <dd class="text-sm text-base-content font-mono bg-base-200 px-2 py-1 rounded mt-1"><%= @debug_info[:request][:version] %></dd>
          </div>
        </dl>
      </div>

      <!-- Response Summary -->
      <div class="bg-base-200 border border-base-content/10 rounded-lg p-6 mb-6">
        <h2 class="text-xl font-semibold text-base-content mb-4">API Response Summary</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-primary/20 border border-primary rounded-lg p-4">
            <div class="text-sm text-primary">Vulnerabilities Found</div>
            <div class="text-3xl font-bold text-primary/80"><%= @debug_info[:response][:count] %></div>
          </div>
          <div class="bg-secondary/20 border border-secondary rounded-lg p-4">
            <div class="text-sm text-secondary">Response Time</div>
            <div class="text-3xl font-bold text-secondary"><%= @debug_info[:response][:duration_ms] %>ms</div>
          </div>
        </div>
      </div>

      <!-- Vulnerabilities List -->
      <% if @debug_info[:response][:vulnerabilities].any? %>
        <div class="bg-base-200 border border-base-content/10 rounded-lg p-6 mb-6">
          <h2 class="text-xl font-semibold text-base-content mb-4">Vulnerabilities</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-base-content/10">
              <thead class="bg-base-300">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-base-content/80 uppercase">CVE ID</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-base-content/80 uppercase">Published</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-base-content/80 uppercase">Severity</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-base-content/80 uppercase">CVSS</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-base-content/80 uppercase">Description</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-base-content/10">
                <% @debug_info[:response][:vulnerabilities].each do |vuln| %>
                  <tr class="hover:bg-base-200">
                    <td class="px-4 py-3 text-sm font-mono text-primary"><%= vuln[:cve_id] %></td>
                    <td class="px-4 py-3 text-sm text-base-content/80"><%= vuln[:published]&.to_date || 'N/A' %></td>
                    <td class="px-4 py-3 text-sm">
                      <% case vuln[:severity] %>
                      <% when 'CRITICAL' %>
                        <span class="badge badge-error badge-sm">CRITICAL</span>
                      <% when 'HIGH' %>
                        <span class="badge badge-warning badge-sm">HIGH</span>
                      <% when 'MEDIUM' %>
                        <span class="badge badge-warning badge-sm">MEDIUM</span>
                      <% when 'LOW' %>
                        <span class="badge badge-primary badge-sm">LOW</span>
                      <% else %>
                        <span class="badge badge-ghost badge-sm"><%= vuln[:severity] || 'UNKNOWN' %></span>
                      <% end %>
                    </td>
                    <td class="px-4 py-3 text-sm text-base-content/80"><%= vuln[:cvss_score] || 'N/A' %></td>
                    <td class="px-4 py-3 text-sm text-base-content/80"><%= vuln[:description] %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      <% else %>
        <div class="alert alert-warning mb-6">
          <p>No vulnerabilities found for this vendor/product combination.</p>
          <p class="text-sm mt-2">This could mean:</p>
          <ul class="list-disc list-inside text-sm mt-2 ml-4">
            <li>The vendor/product names don't match the NVD database</li>
            <li>There are genuinely no known vulnerabilities</li>
            <li>The product name needs to be more specific</li>
          </ul>
        </div>
      <% end %>

      <!-- Raw JSON Response -->
      <% if @debug_info[:raw_response].any? %>
        <div class="bg-base-200 border border-base-content/10 rounded-lg p-6">
          <h2 class="text-xl font-semibold text-base-content mb-4">Raw JSON Response (First 3 Records)</h2>
          <pre class="text-xs text-base-content/80 bg-base-300 p-4 rounded overflow-x-auto"><%= JSON.pretty_generate(@debug_info[:raw_response]) %></pre>
        </div>
      <% end %>
    <% end %>

  </div>

</body>
</html>
