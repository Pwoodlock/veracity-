# frozen_string_literal: true

class AddVulnerabilityLookupSettings < ActiveRecord::Migration[8.0]
  def up
    # Add PyVulnerabilityLookup configuration via SystemSetting model
    # These will be stored as individual key-value pairs in system_settings table

    # Default values that will be used if not in ENV or DB
    settings = [
      {
        key: 'vulnerability_lookup_url',
        value: 'https://vulnerability.circl.lu',
        setting_type: 'string',
        description: 'PyVulnerabilityLookup API URL (can be custom instance)'
      },
      {
        key: 'vulnerability_lookup_enabled',
        value: 'true',
        setting_type: 'boolean',
        description: 'Enable/disable CVE vulnerability scanning'
      },
      {
        key: 'vulnerability_lookup_scan_schedule',
        value: '0 2 * * *',
        setting_type: 'string',
        description: 'Cron schedule for automated CVE scans (default: daily at 2 AM)'
      },
      {
        key: 'vulnerability_lookup_notification_threshold',
        value: 'high',
        setting_type: 'string',
        description: 'Minimum severity for Gotify notifications (info, low, medium, high, critical)'
      },
      {
        key: 'vulnerability_lookup_python_path',
        value: '/opt/server-manager/cve_venv/bin/python',
        setting_type: 'string',
        description: 'Path to Python interpreter with PyVulnerabilityLookup installed'
      },
      {
        key: 'vulnerability_lookup_timeout',
        value: '120',
        setting_type: 'integer',
        description: 'Timeout in seconds for vulnerability lookup API calls'
      }
    ]

    settings.each do |setting|
      SystemSetting.find_or_create_by!(key: setting[:key]) do |s|
        s.value = setting[:value]
        s.setting_type = setting[:setting_type]
        s.description = setting[:description]
      end
    end

    puts "✓ Added #{settings.count} vulnerability lookup settings to system_settings table"
  end

  def down
    # Remove vulnerability lookup settings
    keys = [
      'vulnerability_lookup_url',
      'vulnerability_lookup_enabled',
      'vulnerability_lookup_scan_schedule',
      'vulnerability_lookup_notification_threshold',
      'vulnerability_lookup_python_path',
      'vulnerability_lookup_timeout'
    ]

    SystemSetting.where(key: keys).destroy_all
    puts "✓ Removed vulnerability lookup settings from system_settings table"
  end
end
