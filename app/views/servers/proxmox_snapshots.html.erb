<% content_for :head do %>
  <title>Snapshots - <%= @server.hostname %> - Server Manager</title>
<% end %>

<%= render layout: 'shared/sidebar' do %>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header -->
    <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-base-content">Proxmox VE Snapshots</h1>
          <p class="mt-1 text-sm text-base-content/80">
            <%= @server.proxmox_type_display %>: <span class="font-semibold"><%= @server.hostname %></span>
            | Node: <span class="font-mono"><%= @server.proxmox_node %></span>
            | VMID: <span class="font-mono"><%= @server.proxmox_vmid %></span>
          </p>
        </div>
        <div>
          <%= link_to server_path(@server), class: "inline-flex items-center px-4 py-2 border border-base-content/10 bg-base-200 text-base-content text-sm font-medium rounded-lg hover:bg-base-1000 transition" do %>
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Server
          <% end %>
        </div>
      </div>
    </div>

    <!-- Create Snapshot Form -->
    <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg p-6 mb-6">
      <h2 class="text-lg font-semibold text-base-content mb-4">Create New Snapshot</h2>
      <%= form_with url: create_proxmox_snapshot_server_path(@server), method: :post, class: "space-y-4" do |f| %>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <%= label_tag :snap_name, "Snapshot Name", class: "block text-sm font-medium text-base-content/80 mb-2" %>
            <%= text_field_tag :snap_name, nil,
                placeholder: "snapshot-#{Time.current.strftime('%Y%m%d-%H%M')}",
                class: "input input-bordered w-full",
                required: true,
                pattern: "[a-zA-Z0-9_-]+",
                title: "Only letters, numbers, dash, and underscore allowed" %>
            <p class="mt-1 text-xs text-base-content/60">Use only letters, numbers, dash, and underscore</p>
          </div>
          <div>
            <%= label_tag :description, "Description (Optional)", class: "block text-sm font-medium text-base-content/80 mb-2" %>
            <%= text_field_tag :description, nil,
                placeholder: "Manual snapshot - #{Time.current.strftime('%Y-%m-%d %H:%M')}",
                class: "input input-bordered w-full" %>
            <p class="mt-1 text-xs text-base-content/60">Human-readable description</p>
          </div>
        </div>
        <%= button_tag type: "submit", class: "btn btn-secondary" do %>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Create Snapshot
        <% end %>
      <% end %>
    </div>

    <!-- Snapshots List -->
    <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg overflow-hidden">
      <% if @snapshots.any? %>
        <ul class="divide-y divide-base-content/10">
          <% @snapshots.each do |snapshot| %>
            <li class="px-6 py-4 hover:bg-base-300 transition">
              <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center space-x-3">
                    <!-- Snapshot Icon -->
                    <div class="flex-shrink-0">
                      <svg class="h-10 w-10 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                    </div>

                    <!-- Snapshot Details -->
                    <div class="flex-1">
                      <div class="flex items-center space-x-2">
                        <h3 class="text-sm font-medium text-base-content font-mono">
                          <%= snapshot[:name] %>
                        </h3>
                        <% if snapshot[:vmstate] %>
                          <span class="badge badge-success badge-sm">
                            With RAM
                          </span>
                        <% end %>
                      </div>

                      <% if snapshot[:description].present? %>
                        <p class="mt-1 text-sm text-base-content/60">
                          <%= snapshot[:description] %>
                        </p>
                      <% end %>

                      <div class="mt-2 flex items-center space-x-4 text-sm text-base-content/60">
                        <div class="flex items-center">
                          <svg class="flex-shrink-0 mr-1.5 h-4 w-4 text-base-content/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          <%= Time.at(snapshot[:snaptime]).strftime('%Y-%m-%d %H:%M:%S') rescue snapshot[:snaptime] %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Actions -->
                <div class="flex-shrink-0 ml-4 flex space-x-2">
                  <%= button_to rollback_proxmox_snapshot_server_path(@server, snap_name: snapshot[:name]),
                                method: :post,
                                class: "btn btn-warning btn-sm",
                                data: { confirm: "Are you sure you want to rollback to snapshot '#{snapshot[:name]}'? This will revert the #{@server.proxmox_type_display.downcase} to this point in time." } do %>
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                    </svg>
                    Rollback
                  <% end %>

                  <%= button_to delete_proxmox_snapshot_server_path(@server, snap_name: snapshot[:name]),
                                method: :delete,
                                class: "btn btn-error btn-sm",
                                data: { confirm: "Are you sure you want to delete snapshot '#{snapshot[:name]}'? This action cannot be undone." } do %>
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Delete
                  <% end %>
                </div>
              </div>
            </li>
          <% end %>
        </ul>
      <% else %>
        <!-- Empty State -->
        <div class="text-center py-12">
          <svg class="mx-auto h-12 w-12 text-base-content/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <h3 class="mt-2 text-sm font-medium text-base-content">No snapshots found</h3>
          <p class="mt-1 text-sm text-base-content/60">
            This <%= @server.proxmox_type_display.downcase %> has no Proxmox snapshots yet.
          </p>
          <p class="mt-1 text-sm text-base-content/60">
            Create your first snapshot using the form above.
          </p>
        </div>
      <% end %>
    </div>

    <!-- Info Box -->
    <div class="mt-6 bg-base-200 border border-primary rounded-lg p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-primary" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3 flex-1">
          <p class="text-sm text-primary/80">
            <strong>About Proxmox Snapshots:</strong>
          </p>
          <ul class="mt-2 text-sm text-base-content/80 space-y-1 list-disc list-inside">
            <li>Snapshots are point-in-time copies of your <%= @server.proxmox_type_display.downcase %></li>
            <li>You can rollback to any snapshot to restore a previous state</li>
            <% if @server.proxmox_vm? %>
              <li>VM snapshots do not include RAM state (vmstate=0) for faster creation</li>
              <li>Snapshots preserve disk state and configuration</li>
            <% else %>
              <li>LXC snapshots are lightweight and create quickly</li>
            <% end %>
            <li>Use descriptive names to easily identify snapshots later</li>
            <li>Delete old snapshots to free up storage space</li>
          </ul>
        </div>
      </div>
    </div>

  </div>
<% end %>
