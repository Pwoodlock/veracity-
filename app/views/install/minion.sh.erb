#!/bin/bash
#
# Salt Minion Installation Script - Multi-OS Support
# Generated by: <%= request.host %>
#
# Supports: Debian, Ubuntu, RHEL, AlmaLinux, Rocky, CentOS, Fedora, SUSE, Arch
# Usage: curl https://<%= request.host %>/install-minion.sh | sudo bash
#

set -e  # Exit on error

# Configuration
SALT_MASTER="<%= request.host %>"
SALT_VERSION="3007"  # Updated to LTS version

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘  Salt Minion Installation Script (Multi-OS)                    â•‘${NC}"
echo -e "${BLUE}â•‘  Veracity Infrastructure Management - <%= request.host.ljust(28) %>      â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}âœ— Error: This script must be run as root${NC}"
  echo -e "${YELLOW}  Please run: curl https://<%= request.host %>/install-minion.sh | sudo bash${NC}"
  exit 1
fi

# Detect OS
echo -e "${BLUE}[1/7]${NC} Detecting operating system..."

if [ -f /etc/os-release ]; then
  . /etc/os-release
  OS=$ID
  VER=$VERSION_ID
  CODENAME=$VERSION_CODENAME
  OS_FAMILY=""

  # Determine OS family for package manager selection
  case "$OS" in
    ubuntu|debian)
      OS_FAMILY="debian"
      ;;
    rhel|centos|almalinux|rocky|fedora)
      OS_FAMILY="redhat"
      ;;
    sles|opensuse*|suse)
      OS_FAMILY="suse"
      ;;
    arch|manjaro)
      OS_FAMILY="arch"
      ;;
    *)
      OS_FAMILY="unknown"
      ;;
  esac
else
  echo -e "${RED}âœ— Cannot detect OS. /etc/os-release not found${NC}"
  exit 1
fi

echo -e "${GREEN}âœ“${NC} Detected: $PRETTY_NAME"
echo -e "${GREEN}âœ“${NC} OS Family: $OS_FAMILY"

# Check if OS is supported
case "$OS_FAMILY" in
  debian)
    echo -e "${GREEN}âœ“${NC} Debian-based system supported (Ubuntu/Debian)"
    PKG_MANAGER="apt-get"
    ;;
  redhat)
    echo -e "${GREEN}âœ“${NC} Red Hat-based system supported (RHEL/AlmaLinux/Rocky/CentOS/Fedora)"
    # Determine if dnf or yum
    if command -v dnf &> /dev/null; then
      PKG_MANAGER="dnf"
    else
      PKG_MANAGER="yum"
    fi
    echo -e "${GREEN}âœ“${NC} Using package manager: $PKG_MANAGER"
    ;;
  suse)
    echo -e "${GREEN}âœ“${NC} SUSE-based system supported (SLES/openSUSE)"
    PKG_MANAGER="zypper"
    ;;
  arch)
    echo -e "${GREEN}âœ“${NC} Arch-based system supported (Arch/Manjaro)"
    PKG_MANAGER="pacman"
    ;;
  *)
    echo -e "${RED}âœ— Unsupported OS: $OS${NC}"
    echo -e "${YELLOW}  Supported: Debian, Ubuntu, RHEL, AlmaLinux, Rocky, CentOS, Fedora, SUSE, Arch${NC}"
    exit 1
    ;;
esac

# Function to perform complete salt-minion cleanup
cleanup_salt_minion() {
  echo ""
  echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${YELLOW}â•‘  Performing Complete Salt Minion Cleanup                      â•‘${NC}"
  echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""

  # Step 1: Stop and disable services
  echo -e "${BLUE}[Cleanup 1/6]${NC} Stopping salt-minion service..."
  systemctl stop salt-minion 2>/dev/null || true
  systemctl disable salt-minion 2>/dev/null || true
  echo -e "${GREEN}âœ“${NC} Service stopped and disabled"

  # Step 2: Kill any remaining processes
  echo -e "${BLUE}[Cleanup 2/6]${NC} Terminating any remaining salt-minion processes..."
  pkill -9 salt-minion 2>/dev/null || true
  sleep 2

  if pgrep -x salt-minion > /dev/null; then
    echo -e "${YELLOW}âš ${NC}  Some processes still running, attempting force kill..."
    killall -9 salt-minion 2>/dev/null || true
    sleep 1
  fi
  echo -e "${GREEN}âœ“${NC} All processes terminated"

  # Step 3: Remove packages
  echo -e "${BLUE}[Cleanup 3/6]${NC} Removing salt-minion package..."
  case "$OS_FAMILY" in
    debian)
      apt-get remove -y salt-minion 2>/dev/null || true
      apt-get purge -y salt-minion 2>/dev/null || true
      apt-get autoremove -y 2>/dev/null || true
      ;;
    redhat)
      if command -v dnf &> /dev/null; then
        dnf remove -y salt-minion 2>/dev/null || true
      else
        yum remove -y salt-minion 2>/dev/null || true
      fi
      ;;
    suse)
      zypper remove -y salt-minion 2>/dev/null || true
      ;;
    arch)
      pacman -Rns --noconfirm salt 2>/dev/null || true
      ;;
  esac
  echo -e "${GREEN}âœ“${NC} Package removed"

  # Step 4: Remove configuration and data directories
  echo -e "${BLUE}[Cleanup 4/6]${NC} Removing configuration files and directories..."
  rm -rf /etc/salt/minion* 2>/dev/null || true
  rm -rf /etc/salt/pki/minion/ 2>/dev/null || true
  rm -rf /etc/salt/minion.d/ 2>/dev/null || true
  echo -e "${GREEN}âœ“${NC} Configuration removed"

  # Step 5: Remove logs and cache
  echo -e "${BLUE}[Cleanup 5/6]${NC} Removing logs and cache..."
  rm -rf /var/log/salt/minion* 2>/dev/null || true
  rm -rf /var/cache/salt/minion/ 2>/dev/null || true
  rm -rf /var/run/salt/minion/ 2>/dev/null || true
  echo -e "${GREEN}âœ“${NC} Logs and cache cleared"

  # Step 6: Verify cleanup
  echo -e "${BLUE}[Cleanup 6/6]${NC} Verifying complete removal..."
  CLEANUP_ISSUES=0

  if command -v salt-minion &> /dev/null; then
    echo -e "${YELLOW}âš ${NC}  salt-minion command still exists"
    CLEANUP_ISSUES=$((CLEANUP_ISSUES + 1))
  fi

  if pgrep -x salt-minion > /dev/null; then
    echo -e "${YELLOW}âš ${NC}  salt-minion processes still running"
    CLEANUP_ISSUES=$((CLEANUP_ISSUES + 1))
  fi

  if [ -f /etc/salt/minion ]; then
    echo -e "${YELLOW}âš ${NC}  Configuration file still exists"
    CLEANUP_ISSUES=$((CLEANUP_ISSUES + 1))
  fi

  if [ $CLEANUP_ISSUES -eq 0 ]; then
    echo -e "${GREEN}âœ“${NC} Complete removal verified - system is clean"
  else
    echo -e "${YELLOW}âš ${NC}  $CLEANUP_ISSUES issue(s) detected but continuing..."
  fi

  echo ""
  echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${GREEN}â•‘  Cleanup Complete - Ready for Fresh Installation              â•‘${NC}"
  echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""
  sleep 2
}

# Check if Salt minion is already installed
echo ""
echo -e "${BLUE}[2/7]${NC} Checking for existing Salt minion..."

# Comprehensive detection
SALT_INSTALLED=false
SALT_SERVICE_EXISTS=false
SALT_CONFIG_EXISTS=false
SALT_PROCESSES_RUNNING=false

if command -v salt-minion &> /dev/null; then
  SALT_INSTALLED=true
  EXISTING_VERSION=$(salt-minion --version 2>/dev/null | awk '{print $2}' || echo "unknown")
fi

if systemctl list-unit-files | grep -q salt-minion; then
  SALT_SERVICE_EXISTS=true
fi

if [ -f /etc/salt/minion ] || [ -d /etc/salt/pki/minion ]; then
  SALT_CONFIG_EXISTS=true
fi

if pgrep -x salt-minion > /dev/null; then
  SALT_PROCESSES_RUNNING=true
fi

# Report findings
if [ "$SALT_INSTALLED" = true ] || [ "$SALT_SERVICE_EXISTS" = true ] || [ "$SALT_CONFIG_EXISTS" = true ] || [ "$SALT_PROCESSES_RUNNING" = true ]; then
  echo -e "${YELLOW}âš ${NC}  Existing Salt minion installation detected:"

  if [ "$SALT_INSTALLED" = true ]; then
    echo -e "${YELLOW}   â€¢ Package installed: Yes (version: $EXISTING_VERSION)${NC}"
  fi

  if [ "$SALT_SERVICE_EXISTS" = true ]; then
    SERVICE_STATUS=$(systemctl is-active salt-minion 2>/dev/null || echo "inactive")
    echo -e "${YELLOW}   â€¢ Service exists: Yes (status: $SERVICE_STATUS)${NC}"
  fi

  if [ "$SALT_CONFIG_EXISTS" = true ]; then
    echo -e "${YELLOW}   â€¢ Configuration files: Yes${NC}"
  fi

  if [ "$SALT_PROCESSES_RUNNING" = true ]; then
    PROCESS_COUNT=$(pgrep -x salt-minion | wc -l)
    echo -e "${YELLOW}   â€¢ Running processes: $PROCESS_COUNT${NC}"
  fi

  echo ""
  echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${YELLOW}â•‘  REINSTALLATION DETECTED                                       â•‘${NC}"
  echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""
  echo -e "${YELLOW}An existing salt-minion installation was found.${NC}"
  echo -e "${YELLOW}For a clean reinstallation, we recommend complete removal first.${NC}"
  echo ""
  echo -e "${BLUE}Options:${NC}"
  echo -e "  ${GREEN}1)${NC} Complete cleanup and fresh install (RECOMMENDED)"
  echo -e "     - Removes all packages, configs, keys, and logs"
  echo -e "     - Ensures clean state for new installation"
  echo -e "     - Prevents conflicts from old configuration"
  echo ""
  echo -e "  ${YELLOW}2)${NC} Keep existing installation and reconfigure"
  echo -e "     - May fail if existing installation is corrupted"
  echo -e "     - Old keys and configs might conflict"
  echo -e "     - Only recommended if current install is healthy"
  echo ""
  echo -e "${RED}WARNING:${NC} Option 1 will completely remove the current salt-minion."
  echo -e "${RED}         The server will be unmanaged until reinstallation completes.${NC}"
  echo ""

  # Interactive prompt with 30-second timeout
  echo -ne "${BLUE}Choose option (1 or 2) [default: 1 in 30s]: ${NC}"

  if read -t 30 -r CLEANUP_CHOICE; then
    echo ""
  else
    echo ""
    echo -e "${YELLOW}â±  No response - defaulting to option 1 (complete cleanup)${NC}"
    CLEANUP_CHOICE="1"
  fi

  case "$CLEANUP_CHOICE" in
    2)
      echo -e "${YELLOW}ğŸ“ Keeping existing installation - will reconfigure only${NC}"
      ALREADY_INSTALLED=true
      ;;
    *)
      echo -e "${GREEN}ğŸ—‘ï¸  Performing complete cleanup before fresh install${NC}"
      cleanup_salt_minion
      ALREADY_INSTALLED=false
      ;;
  esac
else
  echo -e "${GREEN}âœ“${NC} No existing installation found - proceeding with fresh install"
  ALREADY_INSTALLED=false
fi

# Install Salt minion if not present
if [ "$ALREADY_INSTALLED" = false ]; then
  echo ""
  echo -e "${BLUE}[3/7]${NC} Installing Salt repository for $OS_FAMILY..."

  case "$OS_FAMILY" in
    debian)
      # Debian/Ubuntu installation
      echo -e "${YELLOW}   Setting up Debian/Ubuntu repository...${NC}"

      # Ensure required packages
      apt-get update -qq
      apt-get install -y curl gnupg apt-transport-https ca-certificates

      # Ensure keyrings directory exists
      mkdir -p /etc/apt/keyrings

      # Download Salt public key from Broadcom
      curl -fsSL https://packages.broadcom.com/artifactory/api/security/keypair/SaltProjectKey/public | tee /etc/apt/keyrings/salt-archive-keyring.pgp > /dev/null

      # Add Salt repository
      curl -fsSL https://github.com/saltstack/salt-install-guide/releases/latest/download/salt.sources | tee /etc/apt/sources.list.d/salt.sources > /dev/null

      echo -e "${GREEN}âœ“${NC} Repository configured"
      ;;

    redhat)
      # RHEL/CentOS/AlmaLinux/Rocky/Fedora installation
      echo -e "${YELLOW}   Setting up Red Hat-based repository...${NC}"

      # Import GPG key
      rpm --import https://packages.broadcom.com/artifactory/api/security/keypair/SaltProjectKey/public 2>/dev/null || true

      # Create repo file
      cat > /etc/yum.repos.d/salt.repo << 'EOFR'
[saltproject-repo]
name=Salt Project Repository
baseurl=https://packages.broadcom.com/artifactory/saltproject-rpm/
enabled=1
gpgcheck=1
gpgkey=https://packages.broadcom.com/artifactory/api/security/keypair/SaltProjectKey/public
EOFR

      echo -e "${GREEN}âœ“${NC} Repository configured"
      ;;

    suse)
      # SUSE/openSUSE installation
      echo -e "${YELLOW}   Setting up SUSE repository...${NC}"

      # Import GPG key
      rpm --import https://packages.broadcom.com/artifactory/api/security/keypair/SaltProjectKey/public 2>/dev/null || true

      # Add repository
      zypper addrepo --refresh https://packages.broadcom.com/artifactory/saltproject-rpm/ salt-repo
      zypper --gpg-auto-import-keys refresh

      echo -e "${GREEN}âœ“${NC} Repository configured"
      ;;

    arch)
      # Arch Linux installation (Salt is in AUR or community repos)
      echo -e "${YELLOW}   Arch Linux detected - Salt available in repositories...${NC}"

      # Update package database
      pacman -Sy --noconfirm

      echo -e "${GREEN}âœ“${NC} Package database updated"
      ;;
  esac

  echo ""
  echo -e "${BLUE}[4/7]${NC} Installing Salt minion (master excluded)..."

  case "$OS_FAMILY" in
    debian)
      # Update package lists
      apt-get update -qq 2>/dev/null || apt-get update

      # Install ONLY minion
      echo -e "${YELLOW}   Installing salt-minion package...${NC}"
      DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends salt-minion

      # Prevent master installation
      apt-mark hold salt-master 2>/dev/null || true

      # Remove master if somehow installed
      if command -v salt-master &> /dev/null; then
        echo -e "${YELLOW}   Removing unwanted salt-master package...${NC}"
        systemctl stop salt-master 2>/dev/null || true
        systemctl disable salt-master 2>/dev/null || true
        apt-get remove -y salt-master || true
      fi
      ;;

    redhat)
      # Install using dnf or yum
      echo -e "${YELLOW}   Installing salt-minion package...${NC}"
      $PKG_MANAGER install -y salt-minion

      # Prevent master installation
      if [ "$PKG_MANAGER" = "dnf" ]; then
        dnf versionlock add salt-master 2>/dev/null || true
      elif [ "$PKG_MANAGER" = "yum" ]; then
        yum versionlock add salt-master 2>/dev/null || true
      fi

      # Remove master if installed
      if command -v salt-master &> /dev/null; then
        echo -e "${YELLOW}   Removing unwanted salt-master package...${NC}"
        systemctl stop salt-master 2>/dev/null || true
        systemctl disable salt-master 2>/dev/null || true
        $PKG_MANAGER remove -y salt-master || true
      fi
      ;;

    suse)
      # Install using zypper
      echo -e "${YELLOW}   Installing salt-minion package...${NC}"
      zypper install -y salt-minion

      # Remove master if installed
      if command -v salt-master &> /dev/null; then
        echo -e "${YELLOW}   Removing unwanted salt-master package...${NC}"
        systemctl stop salt-master 2>/dev/null || true
        systemctl disable salt-master 2>/dev/null || true
        zypper remove -y salt-master || true
      fi
      ;;

    arch)
      # Install using pacman
      echo -e "${YELLOW}   Installing salt package...${NC}"
      pacman -S --noconfirm salt

      # Note: Arch's 'salt' package includes both master and minion
      # We'll just disable the master service
      systemctl stop salt-master 2>/dev/null || true
      systemctl disable salt-master 2>/dev/null || true
      systemctl mask salt-master 2>/dev/null || true
      ;;
  esac

  echo -e "${GREEN}âœ“${NC} Salt minion installed successfully"
else
  echo ""
  echo -e "${BLUE}[3/7]${NC} Skipping repository setup (already installed)"
  echo -e "${BLUE}[4/7]${NC} Skipping installation (already installed)"
fi

# Configure Salt minion
echo ""
echo -e "${BLUE}[5/7]${NC} Configuring Salt minion..."

# Backup existing config if it exists
if [ -f /etc/salt/minion ]; then
  cp /etc/salt/minion /etc/salt/minion.backup.$(date +%Y%m%d_%H%M%S)
  echo -e "${YELLOW}   Backed up existing configuration${NC}"
fi

# Create minion configuration
cat > /etc/salt/minion << EOF
# Salt Minion Configuration
# Generated by: <%= request.host %>
# Date: $(date)

# Master Server
master: ${SALT_MASTER}

# Minion ID (hostname-based)
id: $(hostname -f)

# Retry settings
master_tries: -1
master_alive_interval: 30

# Logging
log_level: warning
log_file: /var/log/salt/minion

# Performance
multiprocessing: True
EOF

echo -e "${GREEN}âœ“${NC} Configuration written to /etc/salt/minion"

# Start Salt minion service
echo ""
echo -e "${BLUE}[6/7]${NC} Starting Salt minion service..."
echo -e "${YELLOW}   Starting service (this may take a moment)...${NC}"

# Stop any existing minion process (with timeout)
timeout 5 systemctl stop salt-minion 2>/dev/null || true
pkill -9 salt-minion 2>/dev/null || true
sleep 1

# Reload systemd and enable (with timeout)
timeout 5 systemctl daemon-reload || echo -e "${YELLOW}   (daemon-reload timed out, continuing...)${NC}"
timeout 5 systemctl enable salt-minion 2>/dev/null || true

# Start the service in background to prevent hanging
echo -e "${YELLOW}   Starting minion (connecting to master: ${SALT_MASTER})...${NC}"
timeout 10 systemctl start salt-minion &
START_PID=$!

# Wait for start command with timeout
if wait $START_PID 2>/dev/null; then
  echo -e "${GREEN}âœ“${NC} Start command completed"
else
  echo -e "${YELLOW}   Start command timed out (this is normal)${NC}"
fi

# Give it a moment
sleep 2

# Check if service is running (quick check, don't hang)
if timeout 3 systemctl is-active --quiet salt-minion 2>/dev/null; then
  echo -e "${GREEN}âœ“${NC} Salt minion service is running"
else
  echo -e "${YELLOW}âš ${NC}  Service status unclear, but this is often normal"
  echo -e "${YELLOW}   The minion may still be connecting to the master${NC}"
  echo -e "${YELLOW}   Continuing installation...${NC}"
fi

# Always continue - don't fail on service issues
echo -e "${GREEN}âœ“${NC} Service start initiated"

# Debian-specific fix: Restart service to ensure proper master connection
if [ "$OS_FAMILY" = "debian" ]; then
  echo ""
  echo -e "${YELLOW}ğŸ”„ Debian-based system detected - applying connection fix...${NC}"
  echo -e "${YELLOW}   Performing additional restart for reliable master connection...${NC}"
  sleep 3  # Give initial start time to settle
  timeout 10 systemctl restart salt-minion 2>/dev/null || true
  sleep 2  # Wait for restart to complete
  echo -e "${GREEN}âœ“${NC} Connection fix applied - minion should now appear on dashboard"
fi

# Get minion key fingerprint
echo ""
echo -e "${BLUE}[7/7]${NC} Getting minion key fingerprint..."

# Wait a moment for key to be generated
sleep 2

if [ -f /etc/salt/pki/minion/minion.pub ]; then
  FINGERPRINT=$(salt-call --local key.finger --out=txt | awk '{print $2}')
  echo -e "${GREEN}âœ“${NC} Key fingerprint retrieved"
else
  echo -e "${YELLOW}âš ${NC}  Key not found yet. It may take a moment to generate."
  FINGERPRINT="<pending>"
fi

# Installation complete
echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘  Installation Complete!                                        â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${BLUE}Minion Details:${NC}"
echo -e "  Hostname:    $(hostname -f)"
echo -e "  Minion ID:   $(hostname -f)"
echo -e "  Master:      ${SALT_MASTER}"
echo -e "  Fingerprint: ${FINGERPRINT}"
echo ""
echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${YELLOW}â•‘  IMPORTANT: Next Steps                                         â•‘${NC}"
echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${YELLOW}1.${NC} The minion has connected to ${SALT_MASTER}"
echo -e "${YELLOW}2.${NC} The minion key is PENDING acceptance on the master"
echo -e "${YELLOW}3.${NC} You MUST accept this key before the minion can be managed"
echo ""
echo -e "${BLUE}To accept this key on the master:${NC}"
echo ""
echo -e "${GREEN}Option A - Via Web Interface (Recommended):${NC}"
echo -e "  1. Login to <%= request.protocol + request.host %>/onboarding"
echo -e "  2. View pending keys (refreshed automatically)"
echo -e "  3. Verify fingerprint matches: ${FINGERPRINT}"
echo -e "  4. Click 'Accept' or fill in the form:"
echo -e "     Minion ID:   $(hostname -f)"
echo -e "     Fingerprint: ${FINGERPRINT}"
echo ""
echo -e "${GREEN}Option B - Via Command Line:${NC}"
echo -e "  On master: rails salt:accept_key[$(hostname -f),${FINGERPRINT}]"
echo ""
echo -e "${BLUE}After acceptance:${NC}"
echo -e "  â€¢ The minion will appear in your server dashboard"
echo -e "  â€¢ Auto-sync will update its status every 30 seconds"
echo -e "  â€¢ You can start managing this server remotely"
echo ""
echo -e "${YELLOW}Security Note:${NC}"
echo -e "  Always verify the fingerprint matches before accepting keys!"
echo -e "  Fingerprint: ${GREEN}${FINGERPRINT}${NC}"
echo ""
echo -e "${BLUE}Logs & Troubleshooting:${NC}"
echo -e "  â€¢ Minion logs: /var/log/salt/minion"
echo -e "  â€¢ View logs:   sudo tail -f /var/log/salt/minion"
echo -e "  â€¢ Service:     sudo systemctl status salt-minion"
if [ "$OS_FAMILY" != "debian" ]; then
  echo -e "  â€¢ If key doesn't appear: sudo systemctl restart salt-minion"
fi
echo ""
