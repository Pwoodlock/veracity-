<% content_for :head do %>
  <title>Vulnerability Alerts - <%= SystemSetting.company_name %></title>
<% end %>

<%= render layout: 'shared/sidebar' do %>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header with Stats -->
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-base-content">Vulnerability Alerts</h1>
      <p class="mt-2 text-sm text-base-content/60">Security vulnerabilities detected across your infrastructure</p>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
      <div class="bg-base-200 border border-base-content/10 rounded-lg p-4">
        <div class="text-sm text-base-content/60">Total</div>
        <div class="text-2xl font-bold text-base-content"><%= @stats[:total] %></div>
      </div>
      <div class="bg-base-200 border border-base-content/10 rounded-lg p-4">
        <div class="text-sm text-base-content/60">Active</div>
        <div class="text-2xl font-bold text-info"><%= @stats[:active] %></div>
      </div>
      <div class="bg-base-200 border border-error rounded-lg p-4">
        <div class="text-sm text-base-content/60">Critical</div>
        <div class="text-2xl font-bold text-error"><%= @stats[:critical] %></div>
      </div>
      <div class="bg-base-200 border border-warning rounded-lg p-4">
        <div class="text-sm text-base-content/60">High</div>
        <div class="text-2xl font-bold text-warning"><%= @stats[:high] %></div>
      </div>
      <div class="bg-base-200 border border-secondary rounded-lg p-4">
        <div class="text-sm text-base-content/60">Exploited</div>
        <div class="text-2xl font-bold text-secondary"><%= @stats[:exploited] %></div>
      </div>
    </div>

    <!-- Flash Messages -->
    <% if flash[:notice] %>
      <div class="alert alert-success mb-6">
        <%= flash[:notice] %>
      </div>
    <% end %>

    <% if flash[:error] %>
      <div class="alert alert-error mb-6">
        <%= flash[:error] %>
      </div>
    <% end %>

    <!-- Filters -->
    <div class="mb-6 bg-base-200 border border-base-content/10 rounded-lg p-4">
      <%= form_with url: vulnerability_alerts_path, method: :get, class: "grid grid-cols-1 md:grid-cols-4 gap-4" do |f| %>
        <div>
          <label class="block text-sm font-medium text-base-content/80 mb-2">Status</label>
          <select name="status" class="select select-bordered w-full">
            <option value="">Active Alerts</option>
            <option value="new" <%= 'selected' if params[:status] == 'new' %>>New</option>
            <option value="acknowledged" <%= 'selected' if params[:status] == 'acknowledged' %>>Acknowledged</option>
            <option value="investigating" <%= 'selected' if params[:status] == 'investigating' %>>Investigating</option>
            <option value="patched" <%= 'selected' if params[:status] == 'patched' %>>Patched</option>
            <option value="ignored" <%= 'selected' if params[:status] == 'ignored' %>>Ignored</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-base-content/80 mb-2">Severity</label>
          <select name="severity" class="select select-bordered w-full">
            <option value="">All Severities</option>
            <option value="CRITICAL" <%= 'selected' if params[:severity] == 'CRITICAL' %>>Critical</option>
            <option value="HIGH" <%= 'selected' if params[:severity] == 'HIGH' %>>High</option>
            <option value="MEDIUM" <%= 'selected' if params[:severity] == 'MEDIUM' %>>Medium</option>
            <option value="LOW" <%= 'selected' if params[:severity] == 'LOW' %>>Low</option>
            <option value="INFO" <%= 'selected' if params[:severity] == 'INFO' %>>Info</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-base-content/80 mb-2">Server</label>
          <select name="server_id" class="select select-bordered w-full">
            <option value="">All Servers</option>
            <% Server.order(:hostname).each do |server| %>
              <option value="<%= server.id %>" <%= 'selected' if params[:server_id] == server.id.to_s %>><%= server.hostname %></option>
            <% end %>
          </select>
        </div>
        <div class="flex items-end">
          <button type="submit" class="btn btn-primary w-full">
            Apply Filters
          </button>
        </div>
      <% end %>
    </div>

    <!-- Alerts Table -->
    <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg overflow-hidden">
      <% if @vulnerability_alerts.any? %>
        <table class="min-w-full divide-y divide-base-content/10">
          <thead class="bg-base-300">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">CVE ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">Server</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">Severity</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">CVSS</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">EPSS</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">Published</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-base-content/10">
            <% @vulnerability_alerts.each do |alert| %>
              <tr class="hover:bg-base-200">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div>
                      <div class="text-sm font-medium text-base-content"><%= alert.cve_id %></div>
                      <% if alert.is_exploited %>
                        <span class="badge badge-secondary badge-xs">CISA KEV</span>
                      <% end %>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content/80">
                  <%= alert.server&.hostname || 'Global' %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <% case alert.severity %>
                  <% when 'CRITICAL' %>
                    <span class="badge badge-error">CRITICAL</span>
                  <% when 'HIGH' %>
                    <span class="badge badge-warning">HIGH</span>
                  <% when 'MEDIUM' %>
                    <span class="badge badge-warning badge-outline">MEDIUM</span>
                  <% when 'LOW' %>
                    <span class="badge badge-primary">LOW</span>
                  <% else %>
                    <span class="badge badge-ghost">INFO</span>
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content/80">
                  <%= alert.cvss_score ? number_with_precision(alert.cvss_score, precision: 1) : 'N/A' %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content/80">
                  <%= alert.epss_score ? "#{(alert.epss_score * 100).round(1)}%" : 'N/A' %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content/80">
                  <%= alert.published_at ? time_ago_in_words(alert.published_at) + ' ago' : 'Unknown' %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <% case alert.status %>
                  <% when 'new' %>
                    <span class="badge badge-error">New</span>
                  <% when 'acknowledged' %>
                    <span class="badge badge-warning">Acknowledged</span>
                  <% when 'investigating' %>
                    <span class="badge badge-primary">Investigating</span>
                  <% when 'patched' %>
                    <span class="badge badge-success">Patched</span>
                  <% when 'ignored' %>
                    <span class="badge badge-ghost">Ignored</span>
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                  <div class="flex space-x-2">
                    <%= link_to 'View', vulnerability_alert_path(alert), class: "text-primary hover:text-primary-focus" %>
                    <% if alert.status == 'new' %>
                      <%= button_to 'Ack', acknowledge_vulnerability_alert_path(alert), method: :post, class: "text-warning hover:text-warning/80" %>
                    <% end %>
                    <% if alert.active? %>
                      <%= button_to 'Patch', resolve_vulnerability_alert_path(alert), method: :post, class: "text-success hover:text-success" %>
                      <%= button_to 'Ignore', ignore_vulnerability_alert_path(alert), method: :post, class: "text-base-content/60 hover:text-base-content/80" %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>

        <!-- Pagination -->
        <div class="px-6 py-4 bg-base-300">
          <%== pagy_nav(@pagy) if @pagy %>
        </div>
      <% else %>
        <div class="p-8 text-center">
          <svg class="mx-auto h-12 w-12 text-base-content/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
          <h3 class="mt-2 text-sm font-medium text-base-content">No vulnerability alerts</h3>
          <p class="mt-1 text-sm text-base-content/60">
            <% if params[:status].present? || params[:severity].present? || params[:server_id].present? %>
              No alerts match your current filters.
            <% else %>
              Great! No active vulnerabilities detected.
            <% end %>
          </p>
          <% if params[:status].present? || params[:severity].present? || params[:server_id].present? %>
            <div class="mt-6">
              <%= link_to vulnerability_alerts_path, class: "inline-flex items-center px-4 py-2 border border-base-content/20 rounded-lg text-sm font-medium text-base-content/80 bg-base-200 hover:bg-base-200" do %>
                Clear Filters
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

  </div>
<% end %>
