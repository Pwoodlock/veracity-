<% content_for :head do %>
  <title>CVE Watchlists - Server Manager</title>
<% end %>

<!-- Shared Navigation -->
<%= render 'shared/navigation' %>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="mb-6 flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-base-content">CVE Watchlists</h1>
        <p class="text-base-content/80 mt-1">Configure which products and vendors to monitor for vulnerabilities</p>
      </div>
      <div class="flex gap-3">
        <%= link_to new_cve_watchlist_path,
            class: "btn btn-success" do %>
          <span>Add Watchlist</span>
        <% end %>
        <%= link_to cve_monitoring_path,
            class: "inline-flex items-center px-4 py-2 bg-base-200 text-white rounded-lg hover:bg-base-200 transition-colors" do %>
          <span>‚Üê Back to Dashboard</span>
        <% end %>
      </div>
    </div>

    <!-- Global Watchlists Section -->
    <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg mb-8">
      <div class="p-6 border-b border-base-content/10">
        <h2 class="text-lg font-semibold text-base-content">Global Watchlists</h2>
        <p class="text-sm text-base-content/80 mt-1">These watchlists monitor vulnerabilities across all servers</p>
      </div>

      <% if @global_watchlists && @global_watchlists.any? %>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-base-content/10">
            <thead class="bg-base-100">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">
                  Vendor/Product
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">
                  Description
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">
                  Frequency
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">
                  Last Check
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">
                  Hits
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">
                  Status
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody class="bg-base-200 divide-y divide-base-content/10">
              <% @global_watchlists.each do |watchlist| %>
                <tr class="hover:bg-base-200 transition-colors">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <%= link_to watchlist.display_name, cve_watchlist_path(watchlist),
                        class: "text-primary hover:text-primary-focus font-medium" %>
                  </td>
                  <td class="px-6 py-4 text-sm text-base-content">
                    <%= watchlist.description || '-' %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-3 py-1 text-xs bg-base-200 text-base-content/80 rounded-full">
                      <%= watchlist.frequency.capitalize %>
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content/60">
                    <%= watchlist.last_checked_at&.strftime('%b %d %H:%M') || 'Never' %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="badge badge-primary badge-sm">
                      <%= watchlist.hits_count %>
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="badge <%= watchlist.active? ? 'badge-success' : 'badge-ghost' %> badge-sm">
                      <%= watchlist.active? ? 'Active' : 'Inactive' %>
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <div class="flex items-center gap-3">
                      <%= link_to "Edit", edit_cve_watchlist_path(watchlist),
                          class: "text-primary hover:text-primary-focus font-medium" %>
                      <%= button_to "Scan", scan_cve_watchlist_path(watchlist), method: :post,
                          class: "text-success hover:text-success font-medium" %>
                      <%= button_to "Delete", destroy_cve_watchlist_path(watchlist), method: :delete,
                          data: { turbo_confirm: "Are you sure you want to delete this watchlist?" },
                          class: "text-error hover:text-error font-medium" %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="p-12 text-center">
          <p class="text-base-content/60">No global watchlists configured</p>
          <%= link_to "Create your first watchlist", new_cve_watchlist_path,
              class: "mt-4 inline-block text-primary hover:text-primary-focus" %>
        </div>
      <% end %>
    </div>

    <!-- Server-Specific Watchlists Section -->
    <div class="bg-base-200 border border-base-content/10 rounded-lg shadow-lg">
      <div class="p-6 border-b border-base-content/10">
        <h2 class="text-lg font-semibold text-base-content">Server-Specific Watchlists</h2>
        <p class="text-sm text-base-content/80 mt-1">These watchlists are tied to specific servers</p>
      </div>

      <% if @server_watchlists && @server_watchlists.any? %>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-base-content/10">
            <thead class="bg-base-100">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">
                  Server
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">
                  Vendor/Product
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">
                  Version
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">
                  Last Check
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">
                  Status
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/80 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody class="bg-base-200 divide-y divide-base-content/10">
              <% @server_watchlists.each do |watchlist| %>
                <tr class="hover:bg-base-200 transition-colors">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <%= link_to watchlist.server.hostname, server_path(watchlist.server),
                        class: "text-primary hover:text-primary-focus font-medium" %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
                    <%= watchlist.display_name %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content/60">
                    <%= watchlist.version || 'All versions' %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content/60">
                    <%= watchlist.last_checked_at&.strftime('%b %d %H:%M') || 'Never' %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="badge <%= watchlist.active? ? 'badge-success' : 'badge-ghost' %> badge-sm">
                      <%= watchlist.active? ? 'Active' : 'Inactive' %>
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <div class="flex items-center gap-3">
                      <%= link_to "Edit", edit_cve_watchlist_path(watchlist),
                          class: "text-primary hover:text-primary-focus font-medium" %>
                      <%= button_to "Scan", scan_cve_watchlist_path(watchlist), method: :post,
                          class: "text-success hover:text-success font-medium" %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="p-12 text-center">
          <p class="text-base-content/60">No server-specific watchlists configured</p>
          <p class="text-sm text-base-content/60 mt-2">Server-specific watchlists will be created automatically when servers are scanned</p>
        </div>
      <% end %>
    </div>
  </div>
